<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>太陽能追日系統多案場監控</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* 卡片特效 */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 20px;
        }

        /* 滑鼠移過卡片時浮起 */
        .site-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        /* 數值標籤樣式 */
        .stat-label {
            color: #6c757d;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .unit {
            font-size: 0.9rem;
            color: #adb5bd;
            font-weight: 500;
        }

        /* 四方位光照卡片樣式 */
        .sun-card {
            background: #fff;
            border-left: 4px solid #ffc107;
            /* 黃色邊條 */
        }

        /* 推桿耗能卡片特別樣式 */
        .energy-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #90caf9;
        }

        /* 狀態燈號 */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-online {
            background-color: #d1e7dd;
            color: #0f5132;
        }

        .status-offline {
            background-color: #f8d7da;
            color: #842029;
        }

        /* 導覽列樣式優化 */
        .nav-pills .nav-link {
            color: #495057;
            border-radius: 8px;
            margin-right: 10px;
            padding: 10px 20px;
            font-weight: 500;
        }

        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            box-shadow: 0 4px 6px rgba(13, 110, 253, 0.3);
        }
    </style>
</head>

<body class="py-4">
    <div class="container-fluid container-xl">
        <div class="text-center mb-5">
            <h1 class="fw-bold text-dark">太陽能追日系統多案場監控</h1>
            <p class="text-muted">即時監控各案場發電效能與系統狀態</p>
        </div>

        <div class="card p-3 mb-4">
            <ul class="nav nav-pills" id="mainTab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" onclick="switchTab('overview')">總覽</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('test-system')">測試系統</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('jintudi-traditional')">金土地公廟(傳統)</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('jintudi-smart')">金土地公廟(智能)</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('eng1-traditional')">工程一館(傳統)</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('eng1-smart')">工程一館(智能)</button>
                </li>
            </ul>
        </div>

        <div class="tab-content">

            <div id="overview" class="tab-pane fade show active">
                <div class="row g-4 mb-4">
                    <div class="col-md-6 col-lg-4">
                        <div class="card site-card h-100 p-3" onclick="switchTab('test-system')">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="m-0 fw-bold">測試系統</h5>
                                <span class="status-badge status-online" id="overview-test-status">運行中</span>
                            </div>
                            <div class="text-center py-3">
                                <div class="stat-value text-primary"><span id="overview-test-power">--</span>
                                    <small>W</small>
                                </div>
                                <div class="stat-label">即時功率</div>
                            </div>
                            <div class="text-end text-muted small">
                                更新: <span id="overview-test-update">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="card site-card h-100 p-3" onclick="switchTab('jintudi-traditional')">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="m-0 fw-bold">金土地公廟-傳統</h5>
                                <span class="status-badge status-offline">準備中</span>
                            </div>
                            <div class="text-center py-3">
                                <div class="stat-value text-secondary">-- <small>W</small></div>
                                <div class="stat-label">即時功率</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="m-0">所有案場數據記錄</h4>
                        <div>
                            <button class="btn btn-primary btn-sm me-2" onclick="refreshAllSites()"><i
                                    class="fas fa-sync-alt me-1"></i> 刷新</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="exportAllData()"><i
                                    class="fas fa-download me-1"></i> 匯出</button>
                        </div>
                    </div>
                    <!-- 日期範圍選擇器 -->
                    <div class="mb-3">
                        <label class="form-label small text-muted"><i class="fas fa-calendar-alt me-1"></i>
                            資料範圍:</label>
                        <select id="date-range-selector" class="form-select form-select-sm"
                            style="width: auto; display: inline-block;" onchange="onDateRangeChange()">
                            <option value="7" selected>最近 7 天</option>
                            <option value="30">最近 30 天</option>
                            <option value="90">最近 90 天</option>
                            <option value="all">全部資料</option>
                        </select>
                        <span class="ms-2 small text-muted" id="data-count-info">載入中...</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>系統名稱</th>
                                    <th>時間</th>
                                    <th>功率 (W)</th>
                                    <th>電壓 (V)</th>
                                    <th>電流 (A)</th>
                                    <th>光照 (lux)</th>
                                </tr>
                            </thead>
                            <tbody id="all-sites-table-body">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">載入中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-center align-items-center mt-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="prevPage()" id="prev-btn"><i
                                class="fas fa-chevron-left"></i> 上一頁</button>
                        <span class="mx-3 text-muted">第 <span id="current-page">1</span> / <span
                                id="total-pages">1</span> 頁 (共 <span id="total-count">0</span> 筆)</span>
                        <button class="btn btn-outline-secondary btn-sm" onclick="nextPage()" id="next-btn">下一頁 <i
                                class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <div id="test-system" class="tab-pane fade" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold">測試系統詳細數據</h3>
                    <div>
                        <button class="btn btn-primary" onclick="refreshSiteData('test', 10)"><i
                                class="fas fa-sync-alt"></i> 立即刷新</button>
                        <button class="btn btn-outline-secondary" onclick="exportSiteData(10)"><i
                                class="fas fa-file-export"></i> 匯出數據</button>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-header bg-white border-0 pt-3">
                                <h5 class="card-title fw-bold"><i
                                        class="fas fa-solar-panel text-warning me-2"></i>發電與環境光照</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="p-3 bg-light rounded text-center mb-2">
                                            <div class="stat-label">太陽能板發電功率</div>
                                            <div class="stat-value text-warning"><span id="test-power">--</span>
                                                <small>W</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <label class="small text-muted mb-2 d-block">四方位光照強度 (lux)</label>
                                        <div class="row g-2">
                                            <div class="col-3">
                                                <div class="p-2 border rounded sun-card text-center">
                                                    <div class="small fw-bold">東 (E)</div>
                                                    <div class="fw-bold mt-1" id="test-light-east">--</div>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="p-2 border rounded sun-card text-center">
                                                    <div class="small fw-bold">西 (W)</div>
                                                    <div class="fw-bold mt-1" id="test-light-west">--</div>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="p-2 border rounded sun-card text-center">
                                                    <div class="small fw-bold">南 (S)</div>
                                                    <div class="fw-bold mt-1" id="test-light-south">--</div>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="p-2 border rounded sun-card text-center">
                                                    <div class="small fw-bold">北 (N)</div>
                                                    <div class="fw-bold mt-1" id="test-light-north">--</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded text-center">
                                            <small class="text-muted">電壓</small>
                                            <div class="fw-bold"><span id="test-voltage">--</span> V</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded text-center">
                                            <small class="text-muted">電流</small>
                                            <div class="fw-bold"><span id="test-current">--</span> A</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-header bg-white border-0 pt-3">
                                <h5 class="card-title fw-bold"><i class="fas fa-microchip text-success me-2"></i>樹莓派監控
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-4">
                                        <div class="p-2 bg-light rounded text-center">
                                            <small class="text-muted">電壓</small>
                                            <div class="fw-bold"><span id="test-rpi-voltage">--</span> V</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2 bg-light rounded text-center">
                                            <small class="text-muted">電流</small>
                                            <div class="fw-bold"><span id="test-rpi-current">--</span> A</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2 bg-light rounded text-center">
                                            <small class="text-muted">功率</small>
                                            <div class="fw-bold text-success"><span id="test-rpi-power">--</span> W
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 推桿監控區塊 -->
                <div class="row mt-3">
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-header bg-white border-0 pt-3">
                                <h5 class="card-title fw-bold"><i class="fas fa-arrows-alt-v text-primary me-2"></i>南北推桿
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="p-3 bg-light rounded text-center">
                                            <div class="stat-label">當前角度</div>
                                            <div class="stat-value text-primary"><span id="test-ns-angle">--</span>
                                                <small class="fs-6">°</small></div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-3 bg-light rounded text-center">
                                            <div class="stat-label">伸展長度</div>
                                            <div class="stat-value"><span id="test-ns-extension">--</span> <small
                                                    class="fs-6">mm</small></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-header bg-white border-0 pt-3">
                                <h5 class="card-title fw-bold"><i class="fas fa-arrows-alt-h text-warning me-2"></i>東西推桿
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="p-3 bg-light rounded text-center">
                                            <div class="stat-label">當前角度</div>
                                            <div class="stat-value text-warning"><span id="test-ew-angle">--</span>
                                                <small class="fs-6">°</small></div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-3 bg-light rounded text-center">
                                            <div class="stat-label">伸展長度</div>
                                            <div class="stat-value"><span id="test-ew-extension">--</span> <small
                                                    class="fs-6">mm</small></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 推桿總功率 -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-white border-0 pt-3">
                                <h5 class="card-title fw-bold"><i class="fas fa-cogs text-danger me-2"></i>推桿總功率</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="p-3 bg-light rounded text-center">
                                            <small class="text-muted">總電壓</small>
                                            <div class="fs-4 fw-bold"><span id="test-actuator-total-voltage">--</span> V
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="p-3 bg-light rounded text-center">
                                            <small class="text-muted">總電流</small>
                                            <div class="fs-4 fw-bold"><span id="test-actuator-total-current">--</span> A
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="p-3 bg-danger bg-opacity-10 rounded text-center">
                                            <small class="text-muted">即時功率</small>
                                            <div class="fs-4 fw-bold text-danger"><span
                                                    id="test-actuator-total-power">--</span> W</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card p-3 mt-4">
                    <div class="d-flex align-items-center">
                        <h6 class="mb-0 me-3">自動刷新頻率：</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary"
                                onclick="setTabRefreshInterval('test-system', 3000)">3秒</button>
                            <button class="btn btn-outline-primary"
                                onclick="setTabRefreshInterval('test-system', 5000)">5秒</button>
                            <button class="btn btn-outline-primary"
                                onclick="setTabRefreshInterval('test-system', 10000)">10秒</button>
                            <button class="btn btn-outline-danger" onclick="stopTabRefresh('test-system')">停止</button>
                        </div>
                        <span class="ms-3 text-muted small" id="refresh-status-test">狀態: 待啟動</span>
                    </div>
                    <div id="test-status" class="mt-2 small"></div>
                </div>

                <div class="card p-4 mt-4">
                    <h5 class="card-title mb-3">最新 5 筆記錄</h5>
                    <div id="test-records" class="table-responsive">
                        <div class="text-center text-muted">載入記錄中...</div>
                    </div>
                </div>
            </div>

            <div id="jintudi-traditional" class="tab-pane fade" style="display: none;">
                <div class="card p-5 text-center text-muted">功能開發中...</div>
            </div>
            <div id="jintudi-smart" class="tab-pane fade" style="display: none;">
                <div class="card p-5 text-center text-muted">功能開發中...</div>
            </div>
            <div id="eng1-traditional" class="tab-pane fade" style="display: none;">
                <div class="card p-5 text-center text-muted">功能開發中...</div>
            </div>
            <div id="eng1-smart" class="tab-pane fade" style="display: none;">
                <div class="card p-5 text-center text-muted">功能開發中...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = "/api";
        const tabAutoRefreshIntervals = {};
        let currentPage = 1;
        const itemsPerPage = 10;
        let allSitesData = [];

        document.addEventListener('DOMContentLoaded', function () {
            refreshOverview();
            refreshSiteData('test', 10);
            setTabRefreshInterval('overview', 30000);
        });

        // 切換頁籤功能 (配合 Bootstrap 樣式修改)
        function switchTab(tabId) {
            // 隱藏所有 tab-pane
            document.querySelectorAll('.tab-pane').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('show', 'active');
            });
            // 移除所有 nav-link 的 active 狀態
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

            // 顯示目標 tab
            const targetPane = document.getElementById(tabId);
            if (targetPane) {
                targetPane.style.display = 'block';
                // 稍微延遲加上 show class 以觸發淡入動畫 (Bootstrap fade)
                setTimeout(() => targetPane.classList.add('show', 'active'), 50);
            }

            // 設定按鈕 active
            const buttons = document.querySelectorAll(`button[onclick="switchTab('${tabId}')"]`);
            buttons.forEach(btn => btn.classList.add('active'));

            if (tabId === 'test-system') refreshSiteData('test', 10);
            else if (tabId === 'overview') refreshOverview();
        }

        // 刷新總覽頁面
        async function refreshOverview() {
            try {
                const response = await fetch(`${API_BASE_URL}/power-records/latest/`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('overview-test-power').textContent = data.power_output ? data.power_output.toFixed(2) : '--';
                    document.getElementById('overview-test-update').textContent = new Date(data.timestamp).toLocaleTimeString('zh-TW');
                }
                await refreshAllSitesData();
            } catch (error) { console.error("刷新總覽失敗:", error); }
        }

        // 刷新測試系統詳細數據 (核心修改處)
        async function refreshSiteData(elementPrefix, systemId) {
            try {
                const powerEl = document.getElementById(`${elementPrefix}-power`);
                const statusEl = document.getElementById(`${elementPrefix}-status`);

                // 獲取最新數據
                const response = await fetch(`${API_BASE_URL}/power-records/latest/?system=${systemId}`);

                if (!response.ok) throw new Error("API Error");
                const data = await response.json();

                if (data) {
                    // 1. 更新基本數據
                    if (powerEl) powerEl.textContent = data.power_output ? data.power_output.toFixed(2) : '--';
                    document.getElementById(`${elementPrefix}-voltage`).textContent = data.voltage ? data.voltage.toFixed(2) : '--';
                    document.getElementById(`${elementPrefix}-current`).textContent = data.current ? data.current.toFixed(3) : '--';

                    // 2. 更新四方位光照 (暫時邏輯：若後端沒分開，則四個都顯示相同值)
                    // 未來請在後端 API 加入 light_east, light_west 等欄位
                    const baseLight = data.light_intensity ? data.light_intensity.toFixed(1) : '--';
                    document.getElementById(`${elementPrefix}-light-east`).textContent = data.light_east || baseLight;
                    document.getElementById(`${elementPrefix}-light-west`).textContent = data.light_west || baseLight;
                    document.getElementById(`${elementPrefix}-light-south`).textContent = data.light_south || baseLight;
                    document.getElementById(`${elementPrefix}-light-north`).textContent = data.light_north || baseLight;

                    // 3. 更新推桿數據 & 自動計算功率 (P = V * I)
                    const actVol = data.actuator_voltage || 0;
                    const actCur = data.actuator_current || 0;
                    // 如果後端有直接給 actuator_power 就用後端的，沒有就自己算
                    const actPower = data.actuator_power ? data.actuator_power : (actVol * actCur);

                    document.getElementById(`${elementPrefix}-actuator-voltage`).textContent = actVol.toFixed(2);
                    document.getElementById(`${elementPrefix}-actuator-current`).textContent = actCur.toFixed(3);
                    document.getElementById(`${elementPrefix}-actuator-power`).textContent = actPower.toFixed(2);
                    document.getElementById(`${elementPrefix}-actuator-angle`).textContent = data.actuator_angle ? data.actuator_angle.toFixed(1) : '--';

                    // 4. 更新今日耗能 (Wh) - 暫時顯示 0.00
                    // 這裡預留了位置，等你後端計算好傳回 'actuator_daily_energy' 即可自動顯示
                    const energyEl = document.getElementById(`${elementPrefix}-actuator-energy`);
                    if (energyEl) {
                        energyEl.textContent = data.actuator_daily_energy ? data.actuator_daily_energy.toFixed(2) : "0.00";
                    }

                    // 狀態更新
                    if (statusEl) statusEl.innerHTML = `<span class="text-success"><i class="fas fa-check-circle"></i> 系統連線正常 (${new Date(data.timestamp).toLocaleTimeString()})</span>`;
                }

                // 載入下方表格記錄
                loadSiteRecords(elementPrefix, systemId);

            } catch (error) {
                console.error("載入失敗:", error);
                const statusEl = document.getElementById(`${elementPrefix}-status`);
                if (statusEl) statusEl.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> 連線失敗或無數據</span>`;
            }
        }

        // 載入表格記錄 (包含樣式更新)
        async function loadSiteRecords(elementPrefix, systemId) {
            const container = document.getElementById(`${elementPrefix}-records`);
            try {
                const response = await fetch(`${API_BASE_URL}/power-records/?system=${systemId}&ordering=-timestamp&limit=5`);
                const data = await response.json();
                const records = data.results || data;

                if (records.length > 0) {
                    let html = `<table class="table table-sm table-hover text-center align-middle">
                        <thead class="table-light">
                            <tr><th>時間</th><th>發電(W)</th><th>推桿功率(W)</th><th>推桿角度(°)</th></tr>
                        </thead><tbody>`;

                    records.forEach(r => {
                        html += `<tr>
                            <td>${new Date(r.timestamp).toLocaleTimeString()}</td>
                            <td class="fw-bold text-success">${r.power_output ? r.power_output.toFixed(2) : '-'}</td>
                            <td>${r.actuator_power ? r.actuator_power.toFixed(2) : '-'}</td>
                            <td>${r.actuator_angle ? r.actuator_angle.toFixed(1) : '-'}</td>
                        </tr>`;
                    });
                    html += `</tbody></table>`;
                    container.innerHTML = html;
                }
            } catch (e) { container.innerHTML = "載入錯誤"; }
        }

        // 刷新所有數據列表 (使用後端分頁)
        async function refreshAllSitesData() {
            const tbody = document.getElementById('all-sites-table-body');
            const days = document.getElementById('date-range-selector').value;

            try {
                // 使用後端分頁 API
                const url = `${API_BASE_URL}/power-records/?page=${currentPage}&days=${days}`;
                const response = await fetch(url);
                const data = await response.json();

                // 更新總頁數和總筆數
                const totalCount = data.count || 0;
                const totalPages = Math.ceil(totalCount / 20); // 後端每頁 20 筆

                document.getElementById('total-count').textContent = totalCount;
                document.getElementById('total-pages').textContent = totalPages || 1;
                document.getElementById('current-page').textContent = currentPage;

                // 更新資料範圍資訊
                const daysText = days === 'all' ? '全部' : `最近 ${days} 天`;
                document.getElementById('data-count-info').textContent = `顯示 ${daysText} 的資料 (共 ${totalCount} 筆)`;

                // 更新按鈕狀態
                document.getElementById('prev-btn').disabled = !data.previous;
                document.getElementById('next-btn').disabled = !data.next;

                // 渲染資料
                const records = data.results || [];
                if (records.length > 0) {
                    tbody.innerHTML = '';
                    records.forEach(r => {
                        const row = `<tr>
                            <td><span class="badge bg-secondary">${r.system_name || 'System ' + r.system}</span></td>
                            <td>${new Date(r.timestamp).toLocaleString()}</td>
                            <td class="fw-bold text-success">${r.power_output?.toFixed(2) || '-'}</td>
                            <td>${r.voltage?.toFixed(2) || '-'}</td>
                            <td>${r.current?.toFixed(3) || '-'}</td>
                            <td>${r.light_intensity?.toFixed(1) || '-'}</td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">無數據</td></tr>`;
                }
            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">載入失敗</td></tr>`;
            }
        }



        // 日期範圍改變時重新載入資料
        function onDateRangeChange() {
            currentPage = 1;
            refreshAllSitesData();
        }

        // 分頁導航
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                refreshAllSitesData();
            }
        }

        function nextPage() {
            const totalPages = parseInt(document.getElementById('total-pages').textContent);
            if (currentPage < totalPages) {
                currentPage++;
                refreshAllSitesData();
            }
        }

        function refreshAllSites() {
            currentPage = 1;
            refreshAllSitesData();
        }

        // 定時器設定
        function setTabRefreshInterval(tabId, interval) {
            if (tabAutoRefreshIntervals[tabId]) clearInterval(tabAutoRefreshIntervals[tabId]);

            const statusId = `refresh-status-${tabId === 'test-system' ? 'test' : tabId}`;
            const statusEl = document.getElementById(statusId);
            if (statusEl) statusEl.textContent = `狀態: 每 ${interval / 1000} 秒刷新`;

            tabAutoRefreshIntervals[tabId] = setInterval(() => {
                if (tabId === 'overview') refreshOverview();
                else if (tabId === 'test-system') refreshSiteData('test', 10);
            }, interval);
        }

        function stopTabRefresh(tabId) {
            if (tabAutoRefreshIntervals[tabId]) {
                clearInterval(tabAutoRefreshIntervals[tabId]);
                delete tabAutoRefreshIntervals[tabId];
                const statusEl = document.getElementById(`refresh-status-${tabId === 'test-system' ? 'test' : tabId}`);
                if (statusEl) statusEl.textContent = "狀態: 已停止";
            }
        }

        // 匯出功能 (簡易實作)
        function exportSiteData(sysId) { alert("功能準備中 (等待後端 API 更新)"); }
        function exportAllData() { alert("功能準備中"); }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>